<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>claro.middleware.circuit-breaker documentation</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="highlight/solarized-light.css" /><script type="text/javascript" src="highlight/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a> with <a href="https://github.com/xsc/codox-theme-rdash">RDash UI</a> theme</h2><h1><a href="index.html"><span class="project-title"><span class="project-name">claro/circuit-breaker</span> <span class="project-version">0.1.0-SNAPSHOT</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1 current"><a href="claro.middleware.circuit-breaker.html"><div class="inner"><span>claro.middleware.circuit-breaker</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="claro.middleware.circuit-breaker.html#var-circuit-breaker"><div class="inner"><span>circuit-breaker</span></div></a></li><li class="depth-1"><a href="claro.middleware.circuit-breaker.html#var-configuration"><div class="inner"><span>configuration</span></div></a></li><li class="depth-1"><a href="claro.middleware.circuit-breaker.html#var-registry"><div class="inner"><span>registry</span></div></a></li><li class="depth-1"><a href="claro.middleware.circuit-breaker.html#var-wrap-circuit-breaker"><div class="inner"><span>wrap-circuit-breaker</span></div></a></li><li class="depth-1"><a href="claro.middleware.circuit-breaker.html#var-wrap-circuit-breaker*"><div class="inner"><span>wrap-circuit-breaker*</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">claro.middleware.circuit-breaker</h1><div class="doc"><div class="markdown"><p>Circuit-breaker middleware for <a href="https://github.com/xsc/claro">claro</a> engines, based on <a href="https://github.com/resilience4j/resilience4j#circuitbreaker">resilience4j</a>â€™s circuit-breaker implementation.</p></div></div><div class="public anchor" id="var-circuit-breaker"><h3>circuit-breaker</h3><div class="usage"><code>(circuit-breaker from name)</code></div><div class="doc"><div class="markdown"><p>Create circuit-breaker from the given object, one of:</p>
<ul>
  <li>a <a href="claro.middleware.circuit-breaker.html#var-configuration">configuration</a> map,</li>
  <li>a <code>CircuitBreakerRegistry</code>,</li>
  <li>a <code>CircuitBreakerConfig</code>.</li>
</ul></div></div></div><div class="public anchor" id="var-configuration"><h3>configuration</h3><div class="usage"><code>(configuration {:keys [failure-rate-threshold wait-duration-in-open-state ring-buffer-size-in-half-open-state ring-buffer-size-in-closed-state record-failure-predicate], :or {failure-rate-threshold 50, wait-duration-in-open-state 60000, ring-buffer-size-in-half-open-state 10, ring-buffer-size-in-closed-state 100, record-failure-predicate (constantly true)}})</code></div><div class="doc"><div class="markdown"><p>Create a circuit-breaker configuration.</p>
<ul>
  <li><code>failure-rate-threshold</code>: the percentage (between 1 and 100) of failed  calls that cause the circuit-breaker to open,</li>
  <li><code>:wait-duration-in-open-state</code>: the time in milliseconds before an open  circuit-breaker reverts to its half-open state,</li>
  <li><code>:ring-buffer-size-in-closed-state</code>: the number of calls that are taken  into account when calculating the failure rate for a closed circuit  breaker,</li>
  <li><code>:ring-buffer-size-in-half-open-state</code>: the number of calls that are taken  into account when calculating the failure rate for a half-open circuit  breaker,</li>
  <li><code>:record-failure-predicate</code>: a predicate applied to each observed exception  deciding whether it should contribute to the failure rate.</li>
</ul>
<p>So, based on the default values, at least 50 of the last 100 calls have to have failed for the circuit-breaker to open. It will then stay open for 60s before transitioning into the half-open state, allowing 10 more calls. If 5 or more of those calls failed, it will open back up and close otherwise.</p></div></div><div class="src-link"><a href="https://github.com/xsc/claro.circuit-breaker/blob/master/src/claro/middleware/circuit_breaker.clj#L17">view source</a></div></div><div class="public anchor" id="var-registry"><h3>registry</h3><div class="usage"><code>(registry &amp; [options])</code></div><div class="doc"><div class="markdown"><p>Create a circuit-breaker registry. <code>options</code> are passed to <a href="claro.middleware.circuit-breaker.html#var-configuration">configuration</a>.</p></div></div><div class="src-link"><a href="https://github.com/xsc/claro.circuit-breaker/blob/master/src/claro/middleware/circuit_breaker.clj#L60">view source</a></div></div><div class="public anchor" id="var-wrap-circuit-breaker"><h3>wrap-circuit-breaker</h3><div class="usage"><code>(wrap-circuit-breaker engine dispatch-fn circuit-breakers &amp; [options])</code></div><div class="doc"><div class="markdown"><p>Circuit-breaking middleware that passes each batch to <code>dispatch-fn</code> to generate a value to-be-used to look up a circuit breaker instance in <code>circuit-breakers</code>.</p>
<pre><code class="clojure">(defonce engine
 (-&gt; (engine/engine)
     (wrap-circuit-breaker
       (fn [env batch]
         (or (datasource-for (first batch))
             :default))
       {:database {:name "Database", :wait-duration-in-open-state 5000}
        :default  {:name "Default"}})))
</code></pre>
<p>Any value that is accepted by <a href="claro.middleware.circuit-breaker.html#var-circuit-breaker">circuit-breaker</a> can be used in <code>circuit-breakers</code>.</p></div></div><div class="src-link"><a href="https://github.com/xsc/claro.circuit-breaker/blob/master/src/claro/middleware/circuit_breaker.clj#L182">view source</a></div></div><div class="public anchor" id="var-wrap-circuit-breaker*"><h3>wrap-circuit-breaker*</h3><div class="usage"><code>(wrap-circuit-breaker* engine circuit-breaker-fn &amp; [{:keys [throw-when-open?], :or {throw-when-open? false}}])</code></div><div class="doc"><div class="markdown"><p>Lower-level circuit-breaking middleware, wrapping resolution of batches using a circuit-breaker produced by <code>circuit-breaker-fn</code>.</p>
<pre><code class="clojure">(defonce engine
  (-&gt; (engine/engine)
      (wrap-circuit-breaker*
        (fn [env [resolvable :as batch]]
          (when (instance? NeedsCircuitBreaking resolvable)
            some-circuit-breaker)))))
</code></pre>
<p><code>circuit-breaker-fn</code> will be called with the resolution environment and the batch to resolve and can return <code>nil</code> if no circuit-breaking should be done.</p>
<p>If <code>throw-when-open?</code> is set, an <code>ExceptionInfo</code> will be thrown when a call reaches the open circuit-breaker; otherwise, a claro error value will be returned in place of the actual value.</p>
<p>Note: The circuit breaker will never become active for <code>PureResolvable</code> values.</p></div></div><div class="src-link"><a href="https://github.com/xsc/claro.circuit-breaker/blob/master/src/claro/middleware/circuit_breaker.clj#L142">view source</a></div></div></div></body></html>